<!DOCTYPE html>
<html lang="en">
<head>
    <title>ScamMedian 2000</title>
    <meta charset="UTF-8">
    <script src="lib/twitch.js"></script>

    <script>
        const { Chat } = window.TwitchJs;
        let clientId = 'itiucpl208iwqzl4pfg4hrtcp8l70k';
        var client;
    
        function calcMedian(values) {
            values.sort(function(a,b) {
             return a - b;
            });
    
    
            let lowMiddle = Math.floor( (values.length - 1) / 2);
            let highMiddle = Math.ceil( (values.length - 1) / 2);
            return ( values[lowMiddle] + values[highMiddle]) / 2;
        }
        function connectToChannel() {
            if (client) {
                client.disconnect();
            }
            valid_inputs = {}
            valid_regex = /^\d+$/
            stopped = true
            counter = 0
    
            var channelName = document.getElementById("channelNameInput").value;
            var botInput = document.getElementById("botInput").value;
            var min = document.getElementById("channelMinInput").value;
            var max = document.getElementById("channelMaxInput").value;
            var uniqueResult = document.getElementById("UniqueResultInput").checked;

            var config = {
                clientId
            };
    
            if (botInput) {
                var parts = botInput.split("#");

                config.username = parts[0];
                config.token = parts[1];
            }
    
            client = new Chat(config);

            const run = async () => {
                client.on("*", (message) => {
                    const time = new Date(message.timestamp).toTimeString();
                    const event = message.event || message.command;
                    const channel = message.channel;
                    let msg = message.message || "";

                    if (!message.tags.username || !msg) {
                        return;
                    }
                    
                    if (msg === '!startmedian' && (message.tags.mod || message.tags.badges.broadcaster)) {
                        document.getElementById("chatOutput").innerHTML = '';
                        valid_inputs = {};
                        stopped = false;
                        counter = 0;
                    }
                    if (msg === '!endmedian' && (message.tags.mod || message.tags.badges.broadcaster)) {
                        stopped = true;
                        validVotes = Object.values(valid_inputs);
                        median = Math.ceil(calcMedian(validVotes));
                        document.getElementById("chatOutput").innerHTML += "<br><br><br><b>Median: " + median + "</b>"
                        if (botInput) {
                            client.say(channel, `${validVotes.length} votes cast. Median is: ${median}`);
                        }
                    }

                    if (stopped) return;
                    valid_message = valid_regex.test(msg) && (parseInt(msg) >= min) && (parseInt(msg) <= max)
                    if (valid_message) {
                        counter++
                        valid_inputs[uniqueResult ? message.tags.username : counter] = parseInt(msg)
                    }
                    document.getElementById("chatOutput").innerHTML += "<span style='color: " + (valid_message ? "green" : "red") + ";'>"+ message.tags.username + ": " + msg + "</span><br>";
                });

                await client.connect();
                await client.join(channelName);

                document.getElementById("chatOutput").innerHTML = channelName + ' Connected'
            };

            run();
        }
    </script>
</head>
<body>
<div>
    <h1>Twitch Chat Median calculator</h1>
    <b>Usage: </b>Any Mod or Broadcaster can start the vote with !startmedian in Twitch Chat. To end the vote and see the results use !endmedian. If you want a bot to write results back into a channel provide credentials in the form of "username#oauthtoken" for an account has access to the channel. I use the scambot2000 account for my testing.
<a href="https://github.com/nofuture2077/twitch-chat-median">Source available at Github</a>. License: <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a>
    </br></br></br>
</div>
<div>
    <label for="UniqueResultInput">Unique value per User (last)</label>
    <input type="checkbox" id="UniqueResultInput" name="UniqueResultInput" checked="checked">  
    <br/><br/>
    <label for="channelMinInput">Min:</label>
    <input type="number" id="channelMinInput" name="channelMinInput" value="10">
    <label for="channelMaxInput">Max:</label>
    <input type="number" id="channelMaxInput" name="channelMaxInput" value="999">
    <br/><br/>
    <label for="botInput">BotCredentials (Optional):</label><br/>
    <input type="text" id="botInput" name="botInput">
    <br/><br/>
    <label for="channelNameInput">Channelname:</label>
    <input type="text" id="channelNameInput" name="channelNameInput">
    <button onclick="connectToChannel()">Connect</button>
</div>

<div id="chatOutput"></div>
</body>
</html>