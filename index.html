<!DOCTYPE html>
<html>
<head>
<script src="https://github.com/tmijs/tmi.js/releases/download/v1.8.5/tmi.min.js"></script>
<script>
    var client;

    function median(values) {
        values.sort(function(a,b) {
         return a - b;
        });


        let lowMiddle = Math.floor( (values.length - 1) / 2);
        let highMiddle = Math.ceil( (values.length - 1) / 2);
        return ( values[lowMiddle] + values[highMiddle]) / 2;
    }
    function connectToChannel() {
        if (client) {
            client.disconnect();
        }
        valid_inputs = []
        valid_regex = /^\d+$/
        stopped = true

        var channelName = document.getElementById("channelNameInput").value;
        var min = document.getElementById("channelMinInput").value;
        var max = document.getElementById("channelMaxInput").value;
        client = new tmi.client({
            connection: {
                secure: true,
                reconnect: true
            },
            channels: [channelName]
        });

        client.connect();
        document.getElementById("chatOutput").innerHTML = channelName + ' Connected'

        client.on("message", function (channel, userstate, message, self) {
            if (message === '!startmedian' && (userstate.mod || userstate.badges.broadcaster)) {
                document.getElementById("chatOutput").innerHTML = '';
                valid_inputs = [];
                stopped = false;
            }
            if (message === '!endmedian' && (userstate.mod || userstate.badges.broadcaster)) {
                stopped = true;

                document.getElementById("chatOutput").innerHTML += "<br><br><br><b>Median: " + median(valid_inputs) + "</b>"
            }
            if (stopped) return;
            if (self) return;
            valid_message = valid_regex.test(message) && (parseInt(message) >= min) && (parseInt(message) <= max)
            if (valid_message) {
                valid_inputs.push(parseInt(message))
            }
            document.getElementById("chatOutput").innerHTML += "<span style='color: " + (valid_message ? "green" : "red") + ";'>"+ userstate["display-name"] + ": " + message + "</span><br>";
        });
    }
</script>
</head>
<body>
<div>
    <h1>Twitch Chat Median calculator</h1>
    <b>Usage: </b>Any Mod or Broadcaster can start the vote with !startmedian in Twitch Chat. To end the vote and see the results use !endmedian <a href="https://github.com/nofuture2077/twitch-chat-median">Source available at Github</a>. License: <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a>
    </br></br></br>
</div>
<div>
    <label for="channelMinInput">Min:</label>
    <input type="number" id="channelMinInput" name="channelMinInput" value="10">
    <label for="channelMaxInput">Max:</label>
    <input type="number" id="channelMaxInput" name="channelMaxInput" value="999">
    <br/><br/>
    <label for="channelNameInput">Channelname:</label>
    <input type="text" id="channelNameInput" name="channelNameInput">
    <button onclick="connectToChannel()">Connect</button>
</div>

<div id="chatOutput"></div>
</body>
</html>